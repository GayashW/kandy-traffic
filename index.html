<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kandy Traffic Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans">
    <div class="max-w-5xl mx-auto p-6">
        <header class="flex justify-between items-center border-b border-slate-800 pb-6 mb-8">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-500 tracking-tight">KANDY <span class="text-white">TRAFFIC LIVE</span></h1>
                <p class="text-slate-400 text-sm">Real-time Origin-Destination Analytics for KMTT Corridor</p>
            </div>
            <button id="runBtn" onclick="triggerScrape()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900/20">
                <i class="fas fa-satellite"></i> Start Live Scrape
            </button>
        </header>

        <div id="statusCard" class="hidden bg-slate-900 border border-blue-500/30 p-4 rounded-xl mb-8 animate-pulse">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                <p id="statusText" class="text-blue-400 font-mono text-sm"></p>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
                <div class="bg-slate-800/50 p-4 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold flex items-center gap-2"><i class="fas fa-list"></i> Traffic Logs</h2>
                    <span class="text-xs text-slate-500 italic">Auto-updates every 2 minutes</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800 text-slate-400 uppercase text-xs">
                            <tr>
                                <th class="p-4">Timestamp</th>
                                <th class="p-4">Route Name</th>
                                <th class="p-4">ETA</th>
                                <th class="p-4">Avg Speed</th>
                                <th class="p-4">Process Time</th>
                            </tr>
                        </thead>
                        <tbody id="logBody" class="divide-y divide-slate-800">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const CONFIG = {
            user: "YOUR_USERNAME",
            repo: "YOUR_REPO_NAME",
            token: "YOUR_GITHUB_PAT" // Ensure repo and workflow scopes are enabled
        };

        async function triggerScrape() {
            const btn = document.getElementById('runBtn');
            const card = document.getElementById('statusCard');
            const text = document.getElementById('statusText');

            btn.disabled = true;
            card.classList.remove('hidden');
            text.innerText = "Initializing Headless Chromium on GitHub Actions...";

            try {
                const response = await fetch(`https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/actions/workflows/main.yml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({ ref: 'main' })
                });

                if (response.status === 204) {
                    text.innerText = "Workflow triggered successfully! Scraping Kandy map data. Results will appear in ~90 seconds.";
                    setTimeout(() => location.reload(), 90000);
                } else {
                    throw new Error("API Limit or Auth Error");
                }
            } catch (err) {
                text.innerText = "Error: " + err.message;
                btn.disabled = false;
            }
        }

        async function loadCSV() {
            try {
                const res = await fetch('kandy_od_traffic.csv');
                if (!res.ok) return;
                const data = await res.text();
                const rows = data.trim().split('\n').slice(1).reverse();
                const tbody = document.getElementById('logBody');

                rows.forEach(row => {
                    const [time, route, eta, dist, speed, proc] = row.split(',');
                    const speedColor = parseFloat(speed) < 15 ? 'text-red-500' : (parseFloat(speed) < 30 ? 'text-orange-400' : 'text-green-500');
                    
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-800/50 transition">
                            <td class="p-4 text-slate-400">${time}</td>
                            <td class="p-4 font-bold text-blue-400">${route.replace(/_/g, ' ')}</td>
                            <td class="p-4 font-mono">${eta} min</td>
                            <td class="p-4 font-bold ${speedColor}">${speed} km/h</td>
                            <td class="p-4 text-slate-500 text-xs">${proc}s</td>
                        </tr>`;
                });
            } catch (e) { console.log("No data yet."); }
        }
        loadCSV();
    </script>
</body>
</html>
